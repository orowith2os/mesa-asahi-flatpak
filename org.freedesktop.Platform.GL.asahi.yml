id: org.freedesktop.Platform.GL.asahi
branch: '22.08'
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '22.08'
build-extension: true
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14
build-options:
  prepend-path: /usr/lib/sdk/llvm14/bin
  prepend-ld-library-path: /usr/lib/sdk/llvm14/lib
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/aclocal
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - name: libdrm-aarch64
    only-arches: [aarch64]
    build-options:
      prefix: /usr/lib/aarch64-linux-gnu/GL/asahi
    buildsystem: meson
    config-opts: &libdrm-config-opts
      - -Dcairo-tests=disabled
      - -Dman-pages=disabled
      - -Dudev=false
    sources: &libdrm-sources
      - type: git
        url: https://gitlab.freedesktop.org/mesa/drm.git
        tag: libdrm-2.4.114
        commit: b9ca37b3134861048986b75896c0915cbf2e97f9

  - name: libdrm-x86_64
    only-arches: [x86_64]
    build-options:
      prefix: /usr/lib/x86_64-linux-gnu/GL/asahi
    buildsystem: meson
    config-opts: *libdrm-config-opts
    sources: *libdrm-sources

  - name: mesa-aarch64
    only-arches: [aarch64]
    build-options:
      prefix: /usr/lib/aarch64-linux-gnu/GL/asahi
      prepend-pkg-config-path: /usr/lib/aarch64-linux-gnu/GL/asahi/lib/pkgconfig
    buildsystem: meson
    config-opts: &mesa-config-opts
      - -Dgallium-drivers=asahi,swrast,virgl,zink,kmsro
      - -Dzstd=enabled
      - -Dgbm=enabled
      - -Dplatforms=x11,wayland
      - -Dvideo-codecs=h264dec,h264enc,h265dec,h265enc,vc1dec
      - -Dvulkan-drivers=swrast
      - -Ddri3=enabled
      - -Degl=enabled
      - -Dgallium-rusticl=false
      - -Dgallium-va=disabled
      - -Dgallium-vdpau=disabled
      - -Dgallium-xa=disabled
      - -Dglx=dri
      - -Dvalgrind=enabled
      - -Dmicrosoft-clc=disabled
    sources: &mesa-sources
      - type: archive
        url: https://gitlab.freedesktop.org/asahi/mesa/-/archive/01a8a3f3d6089d980e7ae56f6e631c8213f0e49d/mesa-01a8a3f3d6089d980e7ae56f6e631c8213f0e49d.tar.bz2
        sha256: 3beb1b1c02f978c9a0a233f35c36002950718b21844c6bef38ed847ebbef46b1
        x-checker-data:
          type: html
          url: https://github.com/AsahiLinux/PKGBUILDs/raw/main/mesa-asahi-edge/PKGBUILD
          version-pattern: _commit=(.+)
          url-template: https://gitlab.freedesktop.org/asahi/mesa/-/archive/$version/mesa-$version.tar.bz2

  - name: mesa-x86_64
    only-arches: [x86_64]
    build-options:
      prefix: /usr/lib/x86_64-linux-gnu/GL/asahi
      prepend-pkg-config-path: /usr/lib/x86_64-linux-gnu/GL/asahi/lib/pkgconfig
    buildsystem: meson
    config-opts: *mesa-config-opts
    sources: *mesa-sources

  - name: llvm
    buildsystem: simple
    build-commands:
      - cp /usr/lib/sdk/llvm14/lib/libLLVM-14.so /usr/lib/$(uname -m)-linux-gnu/GL/asahi/lib

  # Dummy 'module' so that external-data-checker uses the pkgver in the metainfo
  # instead of the Git commit.
  - name: version
    only-arches: [never]
    sources:
      - type: archive
        url: https://httpbin.org/anything/23.0.0_pre$_asahiver
        sha256: 4438d940dd6e7e44ffe6b5e7563519a9a1f4507129d63ee813a19656d52e3560
        x-checker-data:
          type: html
          url: https://github.com/AsahiLinux/PKGBUILDs/raw/main/mesa-asahi-edge/PKGBUILD
          version-pattern: pkgver=(.+)
          url-template: https://httpbin.org/anything/$version
          is-main-module: true
